<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Detailed Audio Analysis And Visualization</title>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <style>
            * {
                font-family: 'Helvetica Neue', Arial, sans-serif;
                box-sizing: border-box;
                padding: 0;
                margin: 0;
            }
            :root {
                --primary-color: #333;
                --secondary-color: #f0f0f0;
                --highlight-color: #e0e0e0;
                --active-color: #d0d0d0;
                --border-color: #ccc;
                --hover-border-color: #999;
                --active-border-color: #888;
                --shadow-color: rgba(0, 0, 0, 0.1);
                --hover-shadow-color: rgba(0, 0, 0, 0.2);
                --font-size: 14px;
                --transition-speed: 0.3s;
                --button-padding: 10px 20px;
            }
            .container,
            .buttons {
                margin-bottom: 20px;
            }
            .chart-container {
                position: relative;
                height: 1000px;
            }
            .chart {
                display: none;
                position: absolute;
            }
            .line,
            .onset-line {
                fill: none;
                stroke-width: 3px;
            }
            .axis path,
            .axis line {
                stroke: var(--primary-color);
            }
            .axis text {
                font-size: 12px;
                fill: var(--primary-color);
            }
            .toggle-button {
                margin: 5px;
                padding: var(--button-padding);
                font-size: var(--font-size);
                cursor: pointer;
                background-color: var(--secondary-color);
                border: 1px solid var(--border-color);
                border-radius: 5px;
                transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease, transform 0.2s ease,
                    box-shadow var(--transition-speed) ease;
                box-shadow: 0 2px 4px var(--shadow-color);
            }
            .toggle-button:hover {
                background-color: var(--highlight-color);
                border-color: var(--hover-border-color);
                transform: translateY(-2px);
                box-shadow: 0 4px 8px var(--hover-shadow-color);
            }
            .toggle-button:active {
                background-color: var(--active-color);
                border-color: var(--active-border-color);
                transform: translateY(0);
                box-shadow: 0 2px 4px var(--shadow-color);
            }
            .progress-bar {
                width: 7500px;
                height: 1000px;
                position: absolute;
                margin-bottom: 10px;
                top: 0;
                left: 0;
                z-index: 10;
            }
            .progress {
                height: 100%;
                background-color: rgba(0, 0, 0, 0.2);
                width: 0;
                z-index: 11;
            }
        </style>
    </head>
    <body>
        <script>
            let currentAudio = null;

            function drawChart(data, elementId, color, chartType, duration) {
                const margin = { top: 20, right: 30, bottom: 50, left: 40 },
                    width = 7500 - margin.left - margin.right,
                    height = 1000 - margin.top - margin.bottom;

                const svg = d3
                    .select(`#${elementId}`)
                    .append('svg')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom)
                    .append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                const x = d3.scaleLinear().range([0, width]);
                let y = d3.scaleLinear().range([height, 0]);

                x.domain([0, duration]);

                const xAxis = d3
                    .axisBottom(x)
                    .ticks(100)
                    .tickFormat((d) => {
                        return d.toFixed(2);
                    });

                svg.append('g')
                    .attr('transform', `translate(0,${height})`)
                    .call(xAxis)
                    .append('text')
                    .attr('fill', '#000')
                    .attr('x', width / 2)
                    .attr('y', margin.bottom - 10)
                    .attr('text-anchor', 'middle')
                    .text('Time (s)');

                if (chartType === 'line') {
                    const minValue = d3.min(data, (d) => d.value) * 0.95;
                    const maxValue = d3.max(data, (d) => d.value) * 1.05;
                    y.domain([minValue, maxValue]);

                    const line = d3
                        .line()
                        .x((d) => x(d.time))
                        .y((d) => y(d.value));

                    svg.append('path').datum(data).attr('class', 'line').style('stroke', color).attr('d', line);
                } else if (chartType === 'onset') {
                    y.domain([0, 1]);
                    data.forEach((d) => {
                        svg.append('line')
                            .attr('x1', x(d.time))
                            .attr('x2', x(d.time))
                            .attr('y1', 0)
                            .attr('y2', height)
                            .attr('stroke', color)
                            .attr('class', 'onset-line');
                    });
                } else if (chartType === 'tempo') {
                    y.domain([0, 1]);
                    data.forEach((d) => {
                        svg.append('line')
                            .attr('x1', x(d.time))
                            .attr('x2', x(d.time))
                            .attr('y1', 0)
                            .attr('y2', height)
                            .attr('stroke', color)
                            .attr('class', 'tempo-line');
                    });
                }
            }

            function toggleChart(chartId) {
                const chart = document.getElementById(chartId);
                if (chart) {
                    chart.style.display = chart.style.display === 'none' || chart.style.display === '' ? 'block' : 'none';
                } else {
                    console.log(`Chart with ID ${chartId} not found.`);
                }
            }

            function playAudio(audioSrc, progressBar, playButton, volumeSlider) {
                if (currentAudio && currentAudio.src !== audioSrc) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    progressBar.style.width = '0%';
                }

                if (!currentAudio || currentAudio.src !== audioSrc) {
                    currentAudio = new Audio(audioSrc);
                    currentAudio.volume = volumeSlider.value;
                    currentAudio.addEventListener('timeupdate', () => {
                        const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
                        progressBar.style.width = `${progress.toFixed(2)}%`;
                    });
                    currentAudio.addEventListener('ended', () => {
                        progressBar.style.width = '0%';
                        playButton.textContent = 'Play Audio';
                        currentAudio = null;
                    });
                }

                currentAudio.play();
                playButton.textContent = 'Playing...';
            }

            function stopAudio(progressBar, playButton) {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    progressBar.style.width = '0%';
                    playButton.textContent = 'Play Audio';
                    currentAudio = null;
                }
            }

            function changeVolume(volumeSlider) {
                if (currentAudio) {
                    currentAudio.volume = volumeSlider.value;
                }
            }

            function setupProgressBar(progressBar) {
                progressBar.addEventListener('click', (e) => {
                    if (currentAudio) {
                        const rect = progressBar.getBoundingClientRect();
                        const offsetX = e.clientX - rect.left;
                        const width = rect.width;
                        const clickPosition = offsetX / width;
                        currentAudio.currentTime = clickPosition * currentAudio.duration;
                    }
                });
            }

            d3.json('audio_analysis_enhanced.json').then(function (allTracksData) {
                Object.keys(allTracksData).forEach((trackName, index) => {
                    const trackData = allTracksData[trackName];
                    const onsetsChartId = `onsets-chart-${index}`;
                    const timbreChartId = `timbre-chart-${index}`;
                    const loudnessChartId = `loudness-chart-${index}`;
                    const chromaChartId = `chroma-chart-${index}`;
                    const tempoChartId = `tempo-chart-${index}`;
                    const spectralCentroidChartId = `spectral-centroid-chart-${index}`;
                    const spectralBandwidthChartId = `spectral-bandwidth-chart-${index}`;
                    const zeroCrossingChartId = `zero-crossing-chart-${index}`;
                    const spectralContrastChartId = `spectral-contrast-chart-${index}`;

                    const containerDIV = d3.select('body').append('div').attr('class', 'container');

                    containerDIV.append('h2').text(trackName);

                    const audioSrc = `audio/${trackName}`;
                    const playButton = containerDIV
                        .append('button')
                        .attr('class', 'toggle-button')
                        .text('Play Audio')
                        .on('click', function () {
                            playAudio(audioSrc, progressBar.node(), this, volumeSlider.node());
                        });

                    const stopButton = containerDIV
                        .append('button')
                        .attr('class', 'toggle-button')
                        .text('Stop Audio')
                        .on('click', function () {
                            stopAudio(progressBar.node(), playButton.node());
                        });

                    const volumeSlider = containerDIV
                        .append('input')
                        .attr('type', 'range')
                        .attr('min', '0')
                        .attr('max', '1')
                        .attr('step', '0.01')
                        .attr('value', '1')
                        .attr('class', 'volume-slider')
                        .on('input', function () {
                            changeVolume(this);
                        });

                    const buttonsDiv = containerDIV.append('div').attr('class', 'buttons');
                    buttonsDiv
                        .append('button')
                        .attr('class', 'toggle-button')
                        .text('Toggle Onsets')
                        .on('click', () => toggleChart(onsetsChartId));
                    buttonsDiv
                        .append('button')
                        .attr('class', 'toggle-button')
                        .text('Toggle Timbre')
                        .on('click', () => toggleChart(timbreChartId));
                    buttonsDiv
                        .append('button')
                        .attr('class', 'toggle-button')
                        .text('Toggle Loudness')
                        .on('click', () => toggleChart(loudnessChartId));
                    buttonsDiv
                        .append('button')
                        .attr('class', 'toggle-button')
                        .text('Toggle Chroma')
                        .on('click', () => toggleChart(chromaChartId));
                    buttonsDiv
                        .append('button')
                        .attr('class', 'toggle-button')
                        .text('Toggle Tempo')
                        .on('click', () => toggleChart(tempoChartId));
                    buttonsDiv
                        .append('button')
                        .attr('class', 'toggle-button')
                        .text('Toggle Spectral Centroid')
                        .on('click', () => toggleChart(spectralCentroidChartId));
                    buttonsDiv
                        .append('button')
                        .attr('class', 'toggle-button')
                        .text('Toggle Spectral Bandwidth')
                        .on('click', () => toggleChart(spectralBandwidthChartId));
                    buttonsDiv
                        .append('button')
                        .attr('class', 'toggle-button')
                        .text('Toggle Zero Crossing Rate')
                        .on('click', () => toggleChart(zeroCrossingChartId));
                    buttonsDiv
                        .append('button')
                        .attr('class', 'toggle-button')
                        .text('Toggle Spectral Contrast')
                        .on('click', () => toggleChart(spectralContrastChartId));

                    const chartContainerDiv = containerDIV.append('div').attr('class', 'chart-container');

                    const progressBarContainer = chartContainerDiv.append('div').attr('class', 'progress-bar');
                    const progressBar = progressBarContainer.append('div').attr('class', 'progress');

                    setupProgressBar(progressBarContainer.node());

                    const onsetsDiv = chartContainerDiv.append('div').attr('id', onsetsChartId).attr('class', 'chart');
                    const timbreDiv = chartContainerDiv.append('div').attr('id', timbreChartId).attr('class', 'chart');
                    const loudnessDiv = chartContainerDiv.append('div').attr('id', loudnessChartId).attr('class', 'chart');
                    const chromaDiv = chartContainerDiv.append('div').attr('id', chromaChartId).attr('class', 'chart');
                    const tempoDiv = chartContainerDiv.append('div').attr('id', tempoChartId).attr('class', 'chart');
                    const spectralCentroidDiv = chartContainerDiv.append('div').attr('id', spectralCentroidChartId).attr('class', 'chart');
                    const spectralBandwidthDiv = chartContainerDiv.append('div').attr('id', spectralBandwidthChartId).attr('class', 'chart');
                    const zeroCrossingDiv = chartContainerDiv.append('div').attr('id', zeroCrossingChartId).attr('class', 'chart');
                    const spectralContrastDiv = chartContainerDiv.append('div').attr('id', spectralContrastChartId).attr('class', 'chart');

                    const preloadAudio = new Audio(audioSrc);
                    preloadAudio.addEventListener('loadedmetadata', () => {
                        const duration = preloadAudio.duration;
                        drawChart(trackData.onsets, onsetsChartId, 'steelblue', 'onset', duration);
                        drawChart(trackData.timbre[0].mfcc1, timbreChartId, 'rgba(50, 205, 50, 0.6)', 'line', duration);
                        drawChart(trackData.loudness, loudnessChartId, 'rgba(255, 215, 0, 0.6)', 'line', duration);
                        drawChart(trackData.chroma[0].chroma1, chromaChartId, 'rgba(255, 0, 255, 0.6)', 'line', duration);
                        drawChart(trackData.tempo, tempoChartId, 'rgba(255, 69, 0, 0.6)', 'line', duration);
                        drawChart(trackData.spectral_centroid, spectralCentroidChartId, 'rgba(0, 128, 128, 0.6)', 'line', duration);
                        drawChart(trackData.spectral_bandwidth, spectralBandwidthChartId, 'rgba(75, 0, 130, 0.6)', 'line', duration);
                        drawChart(trackData.zero_crossing_rate, zeroCrossingChartId, 'rgba(123, 104, 238, 0.6)', 'line', duration);
                        drawChart(trackData.spectral_contrast[0].contrast1, spectralContrastChartId, 'rgba(255, 99, 71, 0.6)', 'line', duration);
                    });
                });
            });
        </script>
    </body>
</html>
